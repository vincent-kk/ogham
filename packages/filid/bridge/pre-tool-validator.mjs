#!/usr/bin/env node
import{readFileSync as y}from"node:fs";var u={alwaysDo:/^###?\s*(always\s*do)/im,askFirst:/^###?\s*(ask\s*first)/im,neverDo:/^###?\s*(never\s*do)/im};function h(e){if(e.length===0)return 0;let t=e.endsWith(`
`)?e.slice(0,-1):e;return t.length===0?0:t.split(`
`).length}function p(e){let t=[],i=h(e);i>100&&t.push({rule:"line-limit",message:`CLAUDE.md exceeds 100-line limit (${i} lines). Compress or deduplicate content.`,severity:"error"});let r=u.alwaysDo.test(e),n=u.askFirst.test(e),s=u.neverDo.test(e);if(!r||!n||!s){let o=[];r||o.push("Always do"),n||o.push("Ask first"),s||o.push("Never do"),t.push({rule:"missing-boundaries",message:`CLAUDE.md is missing 3-tier boundary sections: ${o.join(", ")}`,severity:"warning"})}return{valid:t.every(o=>o.severity!=="error"),violations:t}}function v(e,t){if(e.length===0)return!1;let i=e.trimEnd().split(`
`),r=t.trimEnd().split(`
`);if(r.length<=i.length)return!1;for(let n=0;n<i.length;n++)if(i[n]!==r[n])return!1;return!0}function f(e,t){let i=[];return t!==void 0&&v(t,e)&&i.push({rule:"append-only",message:"SPEC.md must not be append-only. Restructure and compress content instead of simply appending.",severity:"error"}),{valid:i.every(r=>r.severity!=="error"),violations:i}}function d(e){return e.endsWith("/CLAUDE.md")||e==="CLAUDE.md"}function a(e){return e.endsWith("/SPEC.md")||e==="SPEC.md"}function m(e,t){let i=e.tool_input.file_path??e.tool_input.path??"";if(e.tool_name==="Edit"&&d(i)){let s=(e.tool_input.new_string??"").split(`
`).length;return s>20?{continue:!0,hookSpecificOutput:{additionalContext:`Note: Editing CLAUDE.md via Edit tool with ${s} new lines \u2014 line limit (100) cannot be enforced on partial edits. Verify the final line count does not exceed 100 lines after editing.`}}:{continue:!0}}let r=e.tool_input.content;if(e.tool_name!=="Write"||!r)return{continue:!0};if(d(i)){let n=p(r);if(!n.valid)return{continue:!1,hookSpecificOutput:{additionalContext:`BLOCKED: ${n.violations.filter(l=>l.severity==="error").map(l=>l.message).join("; ")}`}};let s=n.violations.filter(o=>o.severity==="warning");return s.length>0?{continue:!0,hookSpecificOutput:{additionalContext:s.map(o=>o.message).join("; ")}}:{continue:!0}}if(a(i)&&t!==void 0){let n=f(r,t);if(!n.valid)return{continue:!1,hookSpecificOutput:{additionalContext:`BLOCKED: ${n.violations.filter(o=>o.severity==="error").map(o=>o.message).join("; ")}`}}}return{continue:!0}}var g=[];for await(let e of process.stdin)g.push(e);var D=Buffer.concat(g).toString("utf-8"),c;try{let e=JSON.parse(D),t=e.tool_input.file_path??e.tool_input.path??"",i;if(e.tool_name==="Write"&&a(t))try{i=y(t,"utf-8")}catch{}c=m(e,i)}catch{c={continue:!0}}process.stdout.write(JSON.stringify(c));
