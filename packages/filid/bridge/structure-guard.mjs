#!/usr/bin/env node
import{existsSync as _,readdirSync as S}from"node:fs";import*as r from"node:path";var b=["components","utils","types","hooks","helpers","lib","styles","assets","constants"],d=[...b,"test","tests","spec","specs","fixtures","e2e"];function m(t){let e=t.startsWith("__")&&t.endsWith("__")&&t.length>4,n=t.startsWith(".");return e||n}function g(t){return t.hasClaudeMd||t.hasSpecMd?"fractal":m(t.dirName)||d.includes(t.dirName)?"organ":(t.hasIndex??!1)&&!d.includes(t.dirName)&&!m(t.dirName)?"fractal":!t.hasFractalChildren&&t.isLeafDirectory?"organ":t.hasSideEffects??!0?"fractal":"pure-function"}function y(t){return t.endsWith("/CLAUDE.md")||t==="CLAUDE.md"}function C(t){try{if(!_(t))return d.includes(r.basename(t));let e=S(t,{withFileTypes:!0}),n=e.some(a=>a.isFile()&&a.name==="CLAUDE.md"),o=e.some(a=>a.isFile()&&a.name==="SPEC.md"),c=e.filter(a=>a.isDirectory()),u=c.some(a=>{let i=r.join(t,a.name);try{return S(i,{withFileTypes:!0}).some(l=>l.isFile()&&(l.name==="CLAUDE.md"||l.name==="SPEC.md"))}catch{return!1}}),f=c.length===0;return g({dirName:r.basename(t),hasClaudeMd:n,hasSpecMd:o,hasFractalChildren:u,isLeafDirectory:f})==="organ"}catch{return!1}}function D(t){return t.replace(/\\/g,"/").split("/").filter(o=>o.length>0).slice(0,-1)}function A(t){let e=/from\s+['"]([^'"]+)['"]/g,n=[],o;for(;(o=e.exec(t))!==null;)n.push(o[1]);return n}function N(t,e,n){if(!e.startsWith("."))return!1;let o=r.dirname(r.resolve(n,t)),c=r.resolve(o,e);return r.resolve(n,t).startsWith(c+r.sep)}function E(t){if(t.tool_name!=="Write"&&t.tool_name!=="Edit")return{continue:!0};let e=t.tool_input.file_path??t.tool_input.path??"";if(!e)return{continue:!0};let n=t.cwd,o=D(e);if(t.tool_name==="Write"&&y(e)){let i=n;for(let s of o)if(i=r.join(i,s),C(i))return{continue:!1,hookSpecificOutput:{additionalContext:`BLOCKED: Cannot create CLAUDE.md inside organ directory "${s}". Organ directories are leaf-level compartments and should not have their own CLAUDE.md.`}}}let c=[],u=-1,f="";{let i=n;for(let s=0;s<o.length;s++)if(i=r.join(i,o[s]),C(i)){u=s,f=o[s];break}}u!==-1&&u<o.length-1&&c.push(`organ \uB514\uB809\uD1A0\uB9AC "${f}" \uB0B4\uBD80\uC5D0 \uD558\uC704 \uB514\uB809\uD1A0\uB9AC\uB97C \uC0DD\uC131\uD558\uB824 \uD569\uB2C8\uB2E4. Organ \uB514\uB809\uD1A0\uB9AC\uB294 flat leaf \uAD6C\uD68D\uC73C\uB85C \uC911\uCCA9 \uB514\uB809\uD1A0\uB9AC\uB97C \uAC00\uC838\uC11C\uB294 \uC548 \uB429\uB2C8\uB2E4.`);let p=t.tool_input.content??t.tool_input.new_string??"";if(p){let s=A(p).filter(l=>N(e,l,n));s.length>0&&c.push("\uB2E4\uC74C import\uAC00 \uD604\uC7AC \uD30C\uC77C\uC758 \uC870\uC0C1 \uBAA8\uB4C8\uC744 \uCC38\uC870\uD569\uB2C8\uB2E4 (\uC21C\uD658 \uC758\uC874 \uC704\uD5D8): "+s.map(l=>`"${l}"`).join(", "))}return c.length===0?{continue:!0}:{continue:!0,hookSpecificOutput:{additionalContext:`\u26A0\uFE0F Warning from filid structure-guard:
`+c.map((i,s)=>`${s+1}. ${i}`).join(`
`)}}}var x=[];for await(let t of process.stdin)x.push(t);var O=Buffer.concat(x).toString("utf-8"),h;try{let t=JSON.parse(O);h=E(t)}catch{h={continue:!0}}process.stdout.write(JSON.stringify(h));
