#!/usr/bin/env node
import{existsSync as A,readdirSync as C}from"node:fs";import*as o from"node:path";var D=["components","utils","types","hooks","helpers","lib","styles","assets","constants"],d=[...D,"test","tests","spec","specs","fixtures","e2e"];function g(t){let r=t.startsWith("__")&&t.endsWith("__")&&t.length>4,n=t.startsWith(".");return r||n}function y(t){return t.hasClaudeMd||t.hasSpecMd?"fractal":g(t.dirName)||d.includes(t.dirName)?"organ":(t.hasIndex??!1)&&!d.includes(t.dirName)&&!g(t.dirName)?"fractal":!t.hasFractalChildren&&t.isLeafDirectory?"organ":t.hasSideEffects??!0?"fractal":"pure-function"}function S(t){return t.endsWith("/CLAUDE.md")||t==="CLAUDE.md"}var p=new Map;function E(t){let r=p.get(t);if(r!==void 0)return r;try{if(!A(t)){let e=d.includes(o.basename(t));return p.set(t,e),e}let n=C(t,{withFileTypes:!0}),s=n.some(e=>e.isFile()&&e.name==="CLAUDE.md"),a=n.some(e=>e.isFile()&&e.name==="SPEC.md"),c=n.filter(e=>e.isDirectory()),u=c.some(e=>{let l=o.join(t,e.name);try{return C(l,{withFileTypes:!0}).some(m=>m.isFile()&&(m.name==="CLAUDE.md"||m.name==="SPEC.md"))}catch{return!1}}),f=c.length===0,i=y({dirName:o.basename(t),hasClaudeMd:s,hasSpecMd:a,hasFractalChildren:u,isLeafDirectory:f})==="organ";return p.set(t,i),i}catch{return p.set(t,!1),!1}}function N(t){return t.replace(/\\/g,"/").split("/").filter(s=>s.length>0).slice(0,-1)}function O(t){let r=/from\s+['"]([^'"]+)['"]/g,n=[],s;for(;(s=r.exec(t))!==null;)n.push(s[1]);return n}function I(t,r,n){if(!r.startsWith("."))return!1;let s=o.dirname(o.resolve(n,t)),a=o.resolve(s,r);return o.resolve(n,t).startsWith(a+o.sep)}function b(t){if(t.tool_name!=="Write"&&t.tool_name!=="Edit")return{continue:!0};let r=t.tool_input.file_path??t.tool_input.path??"";if(!r)return{continue:!0};let n=t.cwd,s=N(r);if(t.tool_name==="Write"&&S(r)){let i=n;for(let e of s)if(i=o.join(i,e),E(i))return{continue:!1,hookSpecificOutput:{additionalContext:`BLOCKED: Cannot create CLAUDE.md inside organ directory "${e}". Organ directories are leaf-level compartments and should not have their own CLAUDE.md.`}}}let a=[],c=-1,u="";{let i=n;for(let e=0;e<s.length;e++)if(i=o.join(i,s[e]),E(i)){c=e,u=s[e];break}}c!==-1&&c<s.length-1&&a.push(`organ \uB514\uB809\uD1A0\uB9AC "${u}" \uB0B4\uBD80\uC5D0 \uD558\uC704 \uB514\uB809\uD1A0\uB9AC\uB97C \uC0DD\uC131\uD558\uB824 \uD569\uB2C8\uB2E4. Organ \uB514\uB809\uD1A0\uB9AC\uB294 flat leaf \uAD6C\uD68D\uC73C\uB85C \uC911\uCCA9 \uB514\uB809\uD1A0\uB9AC\uB97C \uAC00\uC838\uC11C\uB294 \uC548 \uB429\uB2C8\uB2E4.`);let f=t.tool_input.content??t.tool_input.new_string??"";if(f){let e=O(f).filter(l=>I(r,l,n));e.length>0&&a.push("\uB2E4\uC74C import\uAC00 \uD604\uC7AC \uD30C\uC77C\uC758 \uC870\uC0C1 \uBAA8\uB4C8\uC744 \uCC38\uC870\uD569\uB2C8\uB2E4 (\uC21C\uD658 \uC758\uC874 \uC704\uD5D8): "+e.map(l=>`"${l}"`).join(", "))}return a.length===0?{continue:!0}:{continue:!0,hookSpecificOutput:{additionalContext:`\u26A0\uFE0F Warning from filid structure-guard:
`+a.map((i,e)=>`${e+1}. ${i}`).join(`
`)}}}var x=[];for await(let t of process.stdin)x.push(t);var M=Buffer.concat(x).toString("utf-8"),h;try{let t=JSON.parse(M);h=b(t)}catch{h={continue:!0}}process.stdout.write(JSON.stringify(h));
