#!/usr/bin/env node
import{existsSync as r,readFileSync as x,readdirSync as P}from"node:fs";import{join as j}from"node:path";import{existsSync as p}from"node:fs";import{join as a}from"node:path";var l=".coffaen-meta",g=".coffaen";function d(n){return p(a(n,g))||p(a(n,l))}function o(n,...t){return a(n,l,...t)}function m(n,...t){return a(n,g,...t)}async function S(){let n=[];for await(let t of process.stdin)n.push(t);return Buffer.concat(n).toString("utf-8")}function h(n){process.stdout.write(JSON.stringify(n))}function w(n){let t=n.cwd??process.cwd(),e=[];if(!d(t))return{continue:!0,message:"[coffaen] vault\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4. `/coffaen:setup`\uC744 \uC2E4\uD589\uD558\uC5EC \uC2DC\uC791\uD558\uC138\uC694."};let u=o(t,"wal.json");r(u)&&e.push("[coffaen] \uC774\uC804 \uC138\uC158\uC758 \uBBF8\uC644\uB8CC \uD2B8\uB79C\uC7AD\uC158(WAL)\uC774 \uAC10\uC9C0\uB410\uC2B5\uB2C8\uB2E4. `/coffaen:recover`\uB85C \uBCF5\uAD6C\uD558\uC138\uC694.");let c=o(t,"schedule-log.json");if(r(c))try{let s=JSON.parse(x(c,"utf-8"));s.pending&&s.pending.length>0&&e.push(`[coffaen] \uC608\uC57D\uB41C \uC791\uC5C5 ${s.pending.length}\uAC1C\uAC00 \uC788\uC2B5\uB2C8\uB2E4. \`/coffaen:organize\`\uB85C \uCC98\uB9AC\uD558\uC138\uC694.`)}catch{}let i=o(t,"sessions");if(r(i)){let s=R(i);s&&e.push(`[coffaen] \uC774\uC804 \uC138\uC158 \uC694\uC57D:
${s}`)}let y=o(t,"data-sources.json");if(!r(y)){let s=m(t,"graph.json");r(s)||e.push("[coffaen] \uC678\uBD80 \uB370\uC774\uD130 \uC18C\uC2A4\uAC00 \uC5F0\uACB0\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4. `/coffaen:connect`\uB85C \uC5F0\uACB0\uD558\uC138\uC694.")}return{continue:!0,message:e.length>0?e.join(`

`):void 0}}function R(n){try{let t=P(n).filter(i=>i.endsWith(".md")).sort().reverse();if(t.length===0)return null;let e=j(n,t[0]);return x(e,"utf-8").split(`
`).slice(0,10).join(`
`).trim()||null}catch{return null}}var I=await S(),f;try{let n=JSON.parse(I);f=w(n)}catch{f={continue:!0}}h(f);
