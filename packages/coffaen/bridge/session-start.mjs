#!/usr/bin/env node
import{existsSync as i,readFileSync as S,readdirSync as y}from"node:fs";import{join as _}from"node:path";import{existsSync as p}from"node:fs";import{join as c}from"node:path";var l=".coffaen-meta",w=".coffaen";function g(t){return p(c(t,w))||p(c(t,l))}function s(t,...n){return c(t,l,...n)}async function d(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function m(t){process.stdout.write(JSON.stringify(t))}function h(t){let n=t.cwd??process.cwd(),e=[];if(!g(n))return{continue:!0,message:"[coffaen] vault\uAC00 \uCD08\uAE30\uD654\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4. `/coffaen:setup`\uC744 \uC2E4\uD589\uD558\uC5EC \uC2DC\uC791\uD558\uC138\uC694."};let u=s(n,"wal.json");i(u)&&e.push("[coffaen] \uC774\uC804 \uC138\uC158\uC758 \uBBF8\uC644\uB8CC \uD2B8\uB79C\uC7AD\uC158(WAL)\uC774 \uAC10\uC9C0\uB410\uC2B5\uB2C8\uB2E4. `/coffaen:doctor`\uB85C \uC9C4\uB2E8\uD558\uC138\uC694.");let a=s(n,"schedule-log.json");if(i(a))try{let o=JSON.parse(S(a,"utf-8"));o.pending&&o.pending.length>0&&e.push(`[coffaen] \uC608\uC57D\uB41C \uC791\uC5C5 ${o.pending.length}\uAC1C\uAC00 \uC788\uC2B5\uB2C8\uB2E4. \`/coffaen:organize\`\uB85C \uCC98\uB9AC\uD558\uC138\uC694.`)}catch{}let r=s(n,"sessions");if(i(r)){let o=P(r);o&&e.push(`[coffaen] \uC774\uC804 \uC138\uC158 \uC694\uC57D:
${o}`)}let x=s(n,"data-sources.json");return i(x)||e.push("[coffaen] \uC678\uBD80 \uB370\uC774\uD130 \uC18C\uC2A4\uAC00 \uC5F0\uACB0\uB418\uC9C0 \uC54A\uC558\uC2B5\uB2C8\uB2E4. `/coffaen:connect`\uB85C \uC5F0\uACB0\uD558\uC138\uC694."),{continue:!0,message:e.length>0?e.join(`

`):void 0}}function P(t){try{let n=y(t).filter(r=>r.endsWith(".md")).sort().reverse();if(n.length===0)return null;let e=_(t,n[0]);return S(e,"utf-8").split(`
`).slice(0,10).join(`
`).trim()||null}catch{return null}}var R=await d(),f;try{let t=JSON.parse(R);f=h(t)}catch{f={continue:!0}}m(f);
