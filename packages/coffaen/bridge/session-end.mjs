#!/usr/bin/env node
import{existsSync as d,mkdirSync as N,readdirSync as $,readFileSync as F,statSync as R,unlinkSync as A,writeFileSync as P}from"node:fs";import{join as x}from"node:path";import{existsSync as S}from"node:fs";import{join as c}from"node:path";var g=".coffaen-meta",m=".coffaen";function h(t){return S(c(t,m))||S(c(t,g))}function p(t,...s){return c(t,g,...s)}function y(t,...s){return c(t,m,...s)}async function E(){let t=[];for await(let s of process.stdin)t.push(s);return Buffer.concat(t).toString("utf-8")}function w(t){process.stdout.write(JSON.stringify(t))}var b=30;function I(t){let s=t.cwd??process.cwd();if(!h(s))return{continue:!0};let o=p(s,"sessions");C(o);let i=j(t,s),n=k(),e=x(o,n);try{P(e,i,"utf-8")}catch{}return D(o),{continue:!0}}function j(t,s){let o=new Date().toISOString(),n=["# \uC138\uC158 \uC694\uC57D","",`- **\uC138\uC158 ID**: ${t.session_id??"unknown"}`,`- **\uC885\uB8CC \uC2DC\uAC01**: ${o}`,""],e=_(p(s,"usage-stats.json")),r=_(y(s,"stale-nodes.json")),a=e!==null&&Object.keys(e).length>0,u=r!==null&&Array.isArray(r.paths)&&r.paths.length>0;if(a){n.push("## Vault \uB3C4\uAD6C \uC0AC\uC6A9 \uD604\uD669 (\uB204\uC801)"),n.push("");for(let[f,O]of Object.entries(e))n.push(`- ${f}: ${O}\uD68C`);n.push("")}if(u){n.push("## \uB300\uAE30 \uC911\uC778 \uC778\uB371\uC2A4 \uAC31\uC2E0 (stale nodes)"),n.push("");for(let f of r.paths)n.push(`- ${f}`);n.push("")}return!a&&!u&&(n.push("> \uC774 \uC138\uC158\uC5D0\uC11C \uAE30\uB85D\uB41C \uD65C\uB3D9\uC774 \uC5C6\uC2B5\uB2C8\uB2E4."),n.push("")),(a||u)&&(n.push("> \uC815\uD655\uD55C \uC138\uC158 \uB2E8\uC704 \uD1B5\uACC4\uB294 \uD5A5\uD6C4 \uAC1C\uC120 \uC608\uC815\uC785\uB2C8\uB2E4."),n.push("")),n.join(`
`)}function _(t){if(!d(t))return null;try{return JSON.parse(F(t,"utf-8"))}catch{return null}}function k(){let t=new Date,s=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),e=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return`${s}-${o}-${i}-${n}${e}${r}.md`}function D(t){if(!d(t))return;let s=b*24*60*60*1e3,o=Date.now();try{let i=$(t).filter(n=>n.endsWith(".md"));for(let n of i){let e=x(t,n);try{let r=R(e);o-r.mtimeMs>s&&A(e)}catch{}}}catch{}}function C(t){d(t)||N(t,{recursive:!0})}var T=await E(),l;try{let t=JSON.parse(T);l=I(t)}catch{l={continue:!0}}w(l);
