#!/usr/bin/env node
import{existsSync as i,readFileSync as m,writeFileSync as _,mkdirSync as P}from"node:fs";import{dirname as w}from"node:path";import{existsSync as f}from"node:fs";import{join as r}from"node:path";var u=".coffaen-meta",x=".coffaen";function l(t){return f(r(t,x))||f(r(t,u))}function s(t,...n){return r(t,u,...n)}async function p(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function d(t){process.stdout.write(JSON.stringify(t))}var y=new Set(["coffaen_create","coffaen_update","coffaen_delete","coffaen_move"]);function h(t){let n=t.cwd??process.cwd(),e=t.tool_name??"";if(!l(n)||!y.has(e))return{continue:!0};let o=t.tool_input?.path??t.tool_input?.file_path??t.tool_input?.from_path??null;if(o&&g(n,o),e==="coffaen_move"){let c=t.tool_input?.to_path;c&&g(n,c)}return R(n,e),{continue:!0}}function g(t,n){let e=s(t,"stale-nodes.json"),o=[];if(i(e))try{o=JSON.parse(m(e,"utf-8"))}catch{o=[]}o.includes(n)||(o.push(n),S(e),_(e,JSON.stringify(o,null,2),"utf-8"))}function R(t,n){let e=s(t,"usage-stats.json"),o={};if(i(e))try{o=JSON.parse(m(e,"utf-8"))}catch{o={}}o[n]=(o[n]??0)+1,S(e),_(e,JSON.stringify(o,null,2),"utf-8")}function S(t){let n=w(t);i(n)||P(n,{recursive:!0})}var v=await p(),a;try{let t=JSON.parse(v);a=h(t)}catch{a={continue:!0}}d(a);
