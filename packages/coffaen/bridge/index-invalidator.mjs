#!/usr/bin/env node
import{existsSync as s,readFileSync as S,writeFileSync as h,mkdirSync as w}from"node:fs";import{dirname as O}from"node:path";import{existsSync as a}from"node:fs";import{join as r}from"node:path";var c=".coffaen-meta",u=".coffaen";function f(t){return a(r(t,u))||a(r(t,c))}function p(t,...n){return r(t,c,...n)}function l(t,...n){return r(t,u,...n)}async function d(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function g(t){process.stdout.write(JSON.stringify(t))}var m=new Set(["coffaen_create","coffaen_update","coffaen_delete","coffaen_move"]);function _(t){let n=t.cwd??process.cwd(),o=t.tool_name??"";if(!f(n)||!m.has(o))return{continue:!0};let e=t.tool_input?.path??t.tool_input?.file_path??null;return e&&P(n,e),y(n,o),{continue:!0}}function P(t,n){let o=l(t,"stale-nodes.json"),e={paths:[],updatedAt:new Date().toISOString()};if(s(o))try{e=JSON.parse(S(o,"utf-8"))}catch{e={paths:[],updatedAt:new Date().toISOString()}}e.paths.includes(n)||(e.paths.push(n),e.updatedAt=new Date().toISOString(),x(o),h(o,JSON.stringify(e,null,2),"utf-8"))}function y(t,n){let o=p(t,"usage-stats.json"),e={};if(s(o))try{e=JSON.parse(S(o,"utf-8"))}catch{e={}}e[n]=(e[n]??0)+1,x(o),h(o,JSON.stringify(e,null,2),"utf-8")}function x(t){let n=O(t);s(n)||w(n,{recursive:!0})}var I=await d(),i;try{let t=JSON.parse(I);i=_(t)}catch{i={continue:!0}}g(i);
