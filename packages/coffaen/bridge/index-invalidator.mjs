#!/usr/bin/env node
import{existsSync as i,readFileSync as g,writeFileSync as m,mkdirSync as h}from"node:fs";import{dirname as P}from"node:path";import{existsSync as c}from"node:fs";import{join as r}from"node:path";var u=".coffaen-meta",x=".coffaen";function f(t){return c(r(t,x))||c(r(t,u))}function s(t,...n){return r(t,u,...n)}async function l(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function p(t){process.stdout.write(JSON.stringify(t))}var d=new Set(["coffaen_create","coffaen_update","coffaen_delete","coffaen_move"]);function _(t){let n=t.cwd??process.cwd(),e=t.tool_name??"";if(!f(n)||!d.has(e))return{continue:!0};let o=t.tool_input?.path??t.tool_input?.file_path??null;return o&&w(n,o),y(n,e),{continue:!0}}function w(t,n){let e=s(t,"stale-nodes.json"),o=[];if(i(e))try{o=JSON.parse(g(e,"utf-8"))}catch{o=[]}o.includes(n)||(o.push(n),S(e),m(e,JSON.stringify(o,null,2),"utf-8"))}function y(t,n){let e=s(t,"usage-stats.json"),o={};if(i(e))try{o=JSON.parse(g(e,"utf-8"))}catch{o={}}o[n]=(o[n]??0)+1,S(e),m(e,JSON.stringify(o,null,2),"utf-8")}function S(t){let n=P(t);i(n)||h(n,{recursive:!0})}var O=await l(),a;try{let t=JSON.parse(O);a=_(t)}catch{a={continue:!0}}p(a);
