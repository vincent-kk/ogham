# 02. 데이터 흐름

## 전체 파이프라인

```
마크다운 저장소 (.md 파일들)
    |
    v
[오프라인 파이프라인]                          [온라인 파이프라인]
    |                                              |
    v                                              v
+---------------+                          +---------------+
| VaultScanner  |                          | QueryEngine   |
| (변경 감지)    |                          | (쿼리 파싱)    |
+-------+-------+                          +-------+-------+
        |                                          |
        v                                          v
+---------------+                          +-------------------+
|DocumentParser |                          |SpreadingActivation|
| (파싱+링크)    |                          | (시드->확산 탐색)  |
+-------+-------+                          +---------+---------+
        |                                            |
        v                                            v
+---------------+                          +-------------------+
| GraphBuilder  |                          | RelevanceRanker   |
| (노드+엣지)   |                          | (SA+구조 랭킹)    |
+-------+-------+                          +---------+---------+
        |                                            |
        v                                            v
+---------------+                          +-------------------+
| DAGConverter  |                          | ContextAssembler  |
| (순환->DAG)   |                          | (토큰 최적화 출력) |
+-------+-------+                          +-------------------+
        |
        v
+----------------+
|WeightCalculator|
| (WP+SCS+PR)   |
+-------+--------+
        |
        v
+----------------+       +-------------------+
|CommunityDetect |       |  MetadataStore    |
| (Phase 2+)     |       |  (.coffaen/)      |
+-------+--------+       +-------------------+
        |                         ^
        +-------------------------+
              직렬화/저장
```

## 오프라인 vs 온라인 분리

| 구분 | 오프라인 (사전 처리) | 온라인 (실시간) |
|------|---------------------|----------------|
| **트리거** | 스킬/CLI 명시 호출, 훅 자동 트리거 | MCP 도구 호출, 훅 컨텍스트 주입 |
| **시간 제약** | 수십 초 허용 (백그라운드 가능) | 100ms 이하 목표 |
| **연산 범위** | 파싱, 그래프 구축, DAG 변환, 가중치 계산, 커뮤니티 탐지 | 시드 선택, 확산 활성화, 랭킹, 컨텍스트 조립 |
| **데이터 소스** | 원본 마크다운 파일 | 사전 계산된 메타데이터 캐시 |
| **저장** | `.coffaen/` 하위 JSON 파일 | 메모리 내 (캐시 로드) |

**분리 근거**: 그래프 구축과 가중치 계산은 O(V+E) ~ O(V*E)로 문서 수에 비례하여 비용이 증가한다. 반면 확산 활성화는 시드 수와 홉 수에 비례하므로, 발화 임계값과 감쇠 인자가 탐색 범위를 제한하는 한 실시간 처리가 가능하다.

## 오프라인 파이프라인 상세

### 전체 빌드 (Full Build)

저장소 전체를 처음부터 인덱싱하는 흐름이다.

```
1. VaultScanner: 전체 파일 목록 수집 (mtime + 해시)
2. DocumentParser: 모든 파일 파싱 (병렬 처리 가능)
3. GraphBuilder: 통합 그래프 구축
   - 디렉토리 트리 -> PARENT_OF/CHILD_OF 엣지
   - 마크다운 링크 -> LINK 엣지
   - 동일 디렉토리 -> SIBLING 엣지
4. DAGConverter: 순환 탐지 + DAG 변환
5. WeightCalculator: 전체 가중치 계산
   - Wu-Palmer: 디렉토리 트리 기반
   - SCS: 경로 수 + 길이 기반
   - PageRank: 반복 수렴까지
6. CommunityDetector: 커뮤니티 탐지 (Phase 2+)
7. MetadataStore: JSON 직렬화 -> .coffaen/ 저장
```

### 증분 갱신 (Incremental Update)

변경된 파일만 재처리하는 흐름이다.

```
1. VaultScanner: 이전 스냅샷과 비교 -> 변경 세트(added/modified/deleted) 계산
2. DocumentParser: 변경된 파일만 재파싱
3. GraphBuilder: 부분 그래프 갱신
   - 추가: 새 노드 + 새 엣지 삽입
   - 수정: 기존 노드의 링크/메타데이터 갱신
   - 삭제: 노드 + 인바운드 엣지 제거
4. WeightCalculator: 로컬 가중치만 재계산
   - 변경 노드의 1-hop 이웃 엣지 가중치 갱신
   - PageRank는 재계산하지 않음 (다음 전체 빌드까지 유지)
5. MetadataStore: 변경분만 직렬화
```

**증분 갱신의 타협**: 로컬 가중치만 갱신하므로 전역 메트릭(PageRank, 커뮤니티)은 마지막 전체 빌드 시점의 스냅샷이다. 이는 속도와 정밀도 사이의 의도적 타협이며, 대부분의 검색 시나리오에서 허용 가능하다.

## 온라인 파이프라인 상세

### 로컬 검색 (Local Query)

특정 노드에서 시작하는 확산 활성화 기반 검색이다.

```
1. QueryEngine: 쿼리 파싱 -> 시드 노드 결정
   - 파일 경로 직접 지정: 해당 노드가 시드
   - 키워드 지정: 키워드가 Frontmatter 태그/제목에 매칭되는 노드들이 시드
2. SpreadingActivation: 시드에서 확산 실행
   - 사전 계산된 엣지 가중치(W[i,j]) 사용
   - 파라미터: 발화 임계값, 감쇠 인자, 최대 홉
3. RelevanceRanker: 활성화 값 + 구조적 근접도로 최종 순위 결정
4. ContextAssembler: 상위 N개 결과를 토큰 예산 내에서 조립
   - 문서 경로 + Frontmatter 요약 + 관계 설명 + 활성화 점수
   - 토큰 예산 초과 시 낮은 순위부터 제거
```

### 글로벌 검색 (Global Query) -- Phase 2+

커뮤니티 요약 기반의 전역적 질문 처리이다.

```
1. QueryEngine: "이 폴더의 핵심 내용은?" 류의 전역 질문 감지
2. CommunityDetector: 사전 계산된 커뮤니티 맵에서 관련 커뮤니티 조회
3. ContextAssembler: 커뮤니티 요약 정보를 컨텍스트로 조립
```

## 메타데이터 캐시 구조 (`.coffaen/`)

```
.coffaen/
  index.json          # 그래프 구조 (노드, 엣지, 인접 리스트)
  weights.json        # 사전 계산된 가중치 (엣지별, 노드별)
  snapshot.json       # 마지막 빌드의 파일 스냅샷 (mtime, 해시)
  communities.json    # 커뮤니티 탐지 결과 (Phase 2+)
```

**설계 결정**: JSON을 선택한 근거:
- 외부 의존성 제로 (SQLite 바인딩 불필요)
- 인간이 직접 열어서 디버깅 가능
- 수천 문서 규모에서 충분한 성능 (로드 시 한 번에 파싱)
- `.coffaen/` 전체를 `.gitignore`에 추가하여 버전 관리에서 제외

**한계**: 수만 문서 이상에서는 JSON 파싱 비용이 무시할 수 없게 된다. 이 임계점에 도달하면 바이너리 직렬화 또는 SQLite로의 전환을 검토한다.
