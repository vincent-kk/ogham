#!/usr/bin/env node
import{existsSync as r,readFileSync as u,readdirSync as R}from"node:fs";import{join as _}from"node:path";function l(t){if(t===null||typeof t!="object")return!1;let n=t;return typeof n.schema_version=="number"&&n.schema_version>=1&&typeof n.name=="string"&&n.name.length>0&&typeof n.greeting=="string"&&n.greeting.length>0}import{existsSync as g}from"node:fs";import{join as c}from"node:path";var d=".maencof-meta",I=".maencof";function h(t){return g(c(t,I))||g(c(t,d))}function s(t,...n){return c(t,d,...n)}async function S(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function y(t){process.stdout.write(JSON.stringify(t))}function x(t){let n=t.cwd??process.cwd(),e=[];if(!h(n))return{continue:!0,message:"[maencof] Vault is not initialized. Run `/maencof:setup` to get started."};let i=P(n);i&&e.push(`[maencof:${i.name}] ${i.greeting}`);let f=s(n,"wal.json");r(f)&&e.push("[maencof] Incomplete transaction (WAL) detected from a previous session. Run `/maencof:doctor` to diagnose.");let a=s(n,"schedule-log.json");if(r(a))try{let o=JSON.parse(u(a,"utf-8"));o.pending&&o.pending.length>0&&e.push(`[maencof] ${o.pending.length} pending task(s) found. Run \`/maencof:organize\` to process.`)}catch{}let p=s(n,"sessions");if(r(p)){let o=j(p);o&&e.push(`[maencof] Previous session summary:
${o}`)}let w=s(n,"data-sources.json");return r(w)||e.push("[maencof] No external data sources connected. Run `/maencof:connect` to set up."),{continue:!0,message:e.length>0?e.join(`

`):void 0}}function P(t){let n=s(t,"companion-identity.json");if(!r(n))return null;try{let e=JSON.parse(u(n,"utf-8"));return l(e)?{name:e.name,greeting:e.greeting}:null}catch{return null}}function j(t){try{let n=R(t).filter(a=>a.endsWith(".md")).sort().reverse();if(n.length===0)return null;let e=_(t,n[0]);return u(e,"utf-8").split(`
`).slice(0,10).join(`
`).trim()||null}catch{return null}}var C=await S(),m;try{let t=JSON.parse(C);m=x(t)}catch{m={continue:!0}}y(m);
