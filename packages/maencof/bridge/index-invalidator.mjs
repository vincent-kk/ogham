#!/usr/bin/env node
import{existsSync as s,mkdirSync as _,readFileSync as h,writeFileSync as S}from"node:fs";import{dirname as P}from"node:path";import{existsSync as a}from"node:fs";import{join as o}from"node:path";var c=".maencof-meta",u=".maencof";function f(t){return a(o(t,u))||a(o(t,c))}function p(t,...n){return o(t,c,...n)}function l(t,...n){return o(t,u,...n)}async function d(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function g(t){process.stdout.write(JSON.stringify(t))}var m=new Set(["maencof_create","maencof_update","maencof_delete","maencof_move","claudemd_merge"]);function x(t){let n=t.cwd??process.cwd(),r=t.tool_name??"";if(!f(n)||!m.has(r))return{continue:!0};let e=t.tool_input?.path??t.tool_input?.file_path??R(t.tool_response)??null;return e&&w(n,e),O(n,r),{continue:!0}}function w(t,n){let r=l(t,"stale-nodes.json"),e={paths:[],updatedAt:new Date().toISOString()};if(s(r))try{e=JSON.parse(h(r,"utf-8"))}catch{e={paths:[],updatedAt:new Date().toISOString()}}e.paths.includes(n)||(e.paths.push(n),e.updatedAt=new Date().toISOString(),y(r),S(r,JSON.stringify(e,null,2),"utf-8"))}function O(t,n){let r=p(t,"usage-stats.json"),e={};if(s(r))try{e=JSON.parse(h(r,"utf-8"))}catch{e={}}e[n]=(e[n]??0)+1,y(r),S(r,JSON.stringify(e,null,2),"utf-8")}function R(t){if(!t)return null;try{if(typeof t.path=="string"&&t.path)return t.path;let n=t.content;if(Array.isArray(n)&&n.length>0){let r=n[0];if(r.type==="text"&&r.text){let e=JSON.parse(r.text);if(typeof e.path=="string"&&e.path)return e.path}}}catch{}return null}function y(t){let n=P(t);s(n)||_(n,{recursive:!0})}var I=await d(),i;try{let t=JSON.parse(I);i=x(t)}catch{i={continue:!0}}g(i);
