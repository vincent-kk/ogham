#!/usr/bin/env node
import{existsSync as S,mkdirSync as M,readFileSync as P,readdirSync as R,statSync as A,unlinkSync as b,writeFileSync as v}from"node:fs";import{join as N}from"node:path";import{existsSync as m}from"node:fs";import{join as u}from"node:path";var g=".maencof-meta",y=".maencof";function E(t){return m(u(t,y))||m(u(t,g))}function p(t,...s){return u(t,g,...s)}function _(t,...s){return u(t,y,...s)}async function w(){let t=[];for await(let s of process.stdin)t.push(s);return Buffer.concat(t).toString("utf-8")}function x(t){process.stdout.write(JSON.stringify(t))}var F=30;function $(t){let s=t.cwd??process.cwd();if(!E(s))return{continue:!0};let o=p(s,"sessions");C(o);let c=j(t,s),n=D(),e=N(o,n);try{v(e,c,"utf-8")}catch{}return T(o),{continue:!0}}function j(t,s){let o=new Date().toISOString(),n=["# Session Summary","",`- **Session ID**: ${t.session_id??"unknown"}`,`- **Ended at**: ${o}`,""],e=t.skills_used??[];if(e.length>0){n.push("## Skills Used"),n.push("");for(let r of e)n.push(`- ${r}`);n.push("")}let i=t.files_modified??[];if(i.length>0){n.push("## Files Modified"),n.push("");for(let r of i)n.push(`- ${r}`);n.push("")}let f=I(p(s,"usage-stats.json")),a=I(_(s,"stale-nodes.json")),l=f!==null&&Object.keys(f).length>0,d=a!==null&&Array.isArray(a.paths)&&a.paths.length>0;if(l){n.push("## Vault Tool Usage (Cumulative)"),n.push("");for(let[r,k]of Object.entries(f))n.push(`- ${r}: ${k}`);n.push("")}if(d){n.push("## Pending Index Updates (Stale Nodes)"),n.push("");for(let r of a.paths)n.push(`- ${r}`);n.push("")}let O=e.length>0||i.length>0;return!l&&!d&&!O&&(n.push("> No activity recorded in this session."),n.push("")),(l||d)&&(n.push("> Per-session statistics will be improved in a future release."),n.push("")),n.join(`
`)}function I(t){if(!S(t))return null;try{return JSON.parse(P(t,"utf-8"))}catch{return null}}function D(){let t=new Date,s=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),e=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${s}-${o}-${c}-${n}${e}${i}.md`}function T(t){if(!S(t))return;let s=F*24*60*60*1e3,o=Date.now();try{let c=R(t).filter(n=>n.endsWith(".md"));for(let n of c){let e=N(t,n);try{let i=A(e);o-i.mtimeMs>s&&b(e)}catch{}}}catch{}}function C(t){S(t)||M(t,{recursive:!0})}var L=await w(),h;try{let t=JSON.parse(L);h=$(t)}catch{h={continue:!0}}x(h);
