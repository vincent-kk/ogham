#!/usr/bin/env node
import{existsSync as S,mkdirSync as P,readFileSync as k,readdirSync as A,statSync as R,unlinkSync as b,writeFileSync as v}from"node:fs";import{join as N}from"node:path";import{existsSync as h}from"node:fs";import{join as a}from"node:path";var g=".maencof-meta",y=".maencof";function E(t){return h(a(t,y))||h(a(t,g))}function p(t,...s){return a(t,g,...s)}function _(t,...s){return a(t,y,...s)}async function w(){let t=[];for await(let s of process.stdin)t.push(s);return Buffer.concat(t).toString("utf-8")}function x(t){process.stdout.write(JSON.stringify(t))}var F=30;function $(t){let s=t.cwd??process.cwd();if(!E(s))return{continue:!0};let o=p(s,"sessions");C(o);let c=D(t,s),n=j(),e=N(o,n);try{v(e,c,"utf-8")}catch{}return T(o),{continue:!0}}function D(t,s){let o=new Date().toISOString(),n=["# Session Summary","",`- **Session ID**: ${t.session_id??"unknown"}`,`- **Ended at**: ${o}`,""],e=t.skills_used??[];if(e.length>0){n.push("## Skills Used"),n.push("");for(let r of e)n.push(`- ${r}`);n.push("")}let i=t.files_modified??[];if(i.length>0){n.push("## Files Modified"),n.push("");for(let r of i)n.push(`- ${r}`);n.push("")}let f=I(p(s,"usage-stats.json")),u=I(_(s,"stale-nodes.json")),d=f!==null&&Object.keys(f).length>0,l=u!==null&&Array.isArray(u.paths)&&u.paths.length>0;if(d){n.push("## Vault Tool Usage (Cumulative)"),n.push("");for(let[r,M]of Object.entries(f))n.push(`- ${r}: ${M}`);n.push("")}if(l){n.push("## Pending Index Updates (Stale Nodes)"),n.push("");for(let r of u.paths)n.push(`- ${r}`);n.push("")}let O=e.length>0||i.length>0;return!d&&!l&&!O&&(n.push("> No activity recorded in this session."),n.push("")),(d||l)&&(n.push("> Per-session statistics will be improved in a future release."),n.push("")),n.join(`
`)}function I(t){if(!S(t))return null;try{return JSON.parse(k(t,"utf-8"))}catch{return null}}function j(){let t=new Date,s=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),e=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0");return`${s}-${o}-${c}-${n}${e}${i}.md`}function T(t){if(!S(t))return;let s=F*24*60*60*1e3,o=Date.now();try{let c=A(t).filter(n=>n.endsWith(".md"));for(let n of c){let e=N(t,n);try{let i=R(e);o-i.mtimeMs>s&&b(e)}catch{}}}catch{}}function C(t){S(t)||P(t,{recursive:!0})}var L=await w(),m;try{let t=JSON.parse(L);m=$(t)}catch{m={continue:!0}}x(m);
