#!/usr/bin/env node
import{existsSync as m,mkdirSync as Y,readFileSync as H,readdirSync as G,statSync as J,unlinkSync as V,writeFileSync as B}from"node:fs";import{join as O}from"node:path";import{appendFileSync as M,existsSync as P,mkdirSync as L,writeFileSync as T}from"node:fs";import{dirname as j,join as y}from"node:path";var F="dailynotes";function I(t){return y(t,".maencof-meta",F)}function N(t,n){let s=n??_(new Date);return y(I(t),`${s}.md`)}function U(t){let n=t.path?` \u2192 ${t.path}`:"";return`- **[${t.time}]** \`${t.category}\` ${t.description}${n}`}function h(t,n){let s=N(t),i=j(s);L(i,{recursive:!0});let e=U(n);if(P(s))M(s,e+`
`,"utf-8");else{let r=`# Dailynote \u2014 ${_(new Date)}

## Activity Log

`;T(s,r+e+`
`,"utf-8")}}function S(t){let n=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0");return`${n}:${s}`}function _(t){let n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${n}-${s}-${i}`}import{existsSync as D}from"node:fs";import{join as l}from"node:path";var x=".maencof-meta",E=".maencof";function $(t){return D(l(t,E))||D(l(t,x))}function f(t,...n){return l(t,x,...n)}function k(t,...n){return l(t,E,...n)}async function A(){let t=[];for await(let n of process.stdin)t.push(n);return Buffer.concat(t).toString("utf-8")}function v(t){process.stdout.write(JSON.stringify(t))}var K=30;function R(t){let n=t.cwd??process.cwd();if(!$(n))return{continue:!0};let s=f(n,"sessions");q(s);let i=W(t,n),e=X(),o=O(s,e);try{B(o,i,"utf-8")}catch{}z(s);try{let r=t.skills_used??[],u=t.files_modified??[],a=[];u.length>0&&a.push(`files: ${u.length}`),r.length>0&&a.push(`skills: ${r.join(", ")}`);let d=a.length>0?` (${a.join(", ")})`:"";h(n,{time:S(new Date),category:"session",description:`Session ended${d}`})}catch{}return{continue:!0}}function W(t,n){let s=new Date().toISOString(),e=["# Session Summary","",`- **Session ID**: ${t.session_id??"unknown"}`,`- **Ended at**: ${s}`,""],o=t.skills_used??[];if(o.length>0){e.push("## Skills Used"),e.push("");for(let c of o)e.push(`- ${c}`);e.push("")}let r=t.files_modified??[];if(r.length>0){e.push("## Files Modified"),e.push("");for(let c of r)e.push(`- ${c}`);e.push("")}let u=w(f(n,"usage-stats.json")),a=w(k(n,"stale-nodes.json")),d=u!==null&&Object.keys(u).length>0,g=a!==null&&Array.isArray(a.paths)&&a.paths.length>0;if(d){e.push("## Vault Tool Usage (Cumulative)"),e.push("");for(let[c,C]of Object.entries(u))e.push(`- ${c}: ${C}`);e.push("")}if(g){e.push("## Pending Index Updates (Stale Nodes)"),e.push("");for(let c of a.paths)e.push(`- ${c}`);e.push("")}let b=o.length>0||r.length>0;return!d&&!g&&!b&&(e.push("> No activity recorded in this session."),e.push("")),(d||g)&&(e.push("> Per-session statistics will be improved in a future release."),e.push("")),e.join(`
`)}function w(t){if(!m(t))return null;try{return JSON.parse(H(t,"utf-8"))}catch{return null}}function X(){let t=new Date,n=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),e=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return`${n}-${s}-${i}-${e}${o}${r}.md`}function z(t){if(!m(t))return;let n=K*24*60*60*1e3,s=Date.now();try{let i=G(t).filter(e=>e.endsWith(".md"));for(let e of i){let o=O(t,e);try{let r=J(o);s-r.mtimeMs>n&&V(o)}catch{}}}catch{}}function q(t){m(t)||Y(t,{recursive:!0})}var Q=await A(),p;try{let t=JSON.parse(Q);p=R(t)}catch{p={continue:!0}}v(p);
