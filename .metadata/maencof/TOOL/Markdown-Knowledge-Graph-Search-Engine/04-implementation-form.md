# 04. 구현 형태

## 개요

Claude Code 플러그인은 네 가지 구현 형태(MCP 도구, Hook, Skill, CLI)를 지원한다. 이 도구의 각 기능이 어떤 형태로 구현되어야 하는지 비교하고, 최적의 하이브리드 조합을 제안한다.

## 구현 형태별 특성

### MCP 도구

AI 에이전트가 JSON-RPC over stdio 프로토콜로 호출하는 도구이다.

**장점**:
- Claude Code 네이티브 통합 -- 에이전트가 자유롭게 호출 가능
- 입력 스키마 검증 (Zod)
- 기존 filid MCP 패턴 재활용 가능

**단점**:
- 에이전트가 도구 호출을 "결정"해야 함 (자동 트리거 아님)
- 도구 수가 많아지면 LLM 도구 목록 컨텍스트 소모 증가

**적합한 기능**: 그래프 쿼리, 관련 문서 탐색, 확산 활성화 실행, 인덱스 상태 조회

### Hook (Claude Code 훅)

Claude Code 이벤트(SessionStart, UserPromptSubmit, PreToolUse, PostToolUse 등)에 자동 반응하는 스크립트이다.

**장점**:
- 사용자/에이전트 개입 없이 자동 동작
- 현재 작업 컨텍스트를 투명하게 보강 가능

**단점**:
- **타임아웃 제약: 3~5초** -- 복잡한 그래프 연산 불가
- 과도한 컨텍스트 주입은 토큰 낭비를 초래
- 세밀한 파라미터 제어 어려움

**적합한 기능**: 파일 변경 시 인덱스 무효화 표시, 세션 시작 시 인덱스 로드, 프롬프트 제출 시 경량 컨텍스트 주입

**부적합한 기능**: 인덱스 빌드, 확산 활성화 전체 실행, 그래프 구축

### Skill (스킬)

사용자가 `/maencof:명령어` 형태로 명시적으로 호출하는 워크플로우이다.

**장점**:
- 시간 제한 없이 복합 연산 가능
- 사용자에게 진행 상황 보고 가능
- 다중 MCP 도구 호출을 오케스트레이션 가능

**단점**:
- 사용자가 명시적으로 호출해야 함
- 자동화 어려움

**적합한 기능**: 전체/증분 인덱스 구축, 대화형 지식 탐색 세션, 인덱스 건강도 진단

### CLI (독립 커맨드라인 도구)

Claude Code 외부에서 실행 가능한 독립 커맨드라인 도구이다.

**장점**:
- 스크립트/cron 통합 가능
- CI/CD 파이프라인에서 사용 가능
- 무제한 실행 시간

**단점**:
- Claude Code 플러그인 생태계와 분리
- MCP/Hook과 코드 중복 가능

**적합한 기능**: 대규모 일괄 인덱싱, 배치 처리, CI 통합

## 기능별 구현 형태 매핑

| 기능 | 구현 형태 | 근거 |
|------|----------|------|
| **전체 인덱스 빌드** | Skill + CLI | 시간 제한 없는 장시간 연산, 사용자 명시 호출 |
| **증분 인덱스 갱신** | Hook (경량) + Skill (전체) | Hook: 파일 변경 시 무효화 표시. Skill: 누적 변경 적용 |
| **관련 문서 검색** | MCP 도구 | AI 에이전트 자동 호출, 실시간 응답 |
| **그래프 탐색** | MCP 도구 | 특정 노드의 이웃/조상/자손 조회 |
| **컨텍스트 주입** | Hook | UserPromptSubmit 시 자동 관련 문서 경로 주입 |
| **인덱스 상태 조회** | MCP 도구 | 에이전트가 인덱스 신선도 확인 |
| **인덱스 건강도 진단** | Skill | 고아 문서, 깨진 링크, 순환 등 상세 분석 |
| **대화형 탐색** | Skill | 다중 MCP 도구 오케스트레이션 |

## 하이브리드 조합 아키텍처

```
+----------------------------------------------------------+
|                    사용자 / AI 에이전트                     |
|                                                           |
|  Skill (/maencof:build)    Hook (UserPromptSubmit)        |
|  Skill (/maencof:explore)  Hook (PostToolUse:Write)       |
|         |                         |                       |
|         v                         v                       |
|  +-------------+          +----------------+              |
|  | 오프라인     |          | 온라인          |              |
|  | 인덱스 빌드  |          | 컨텍스트 주입   |              |
|  | (Skill/CLI) |          | (Hook -> MCP)  |              |
|  +------+------+          +--------+-------+              |
|         |                          |                      |
|         v                          v                      |
|  +----------------------------------------------+        |
|  |          core/ (공유 알고리즘 계층)             |        |
|  |  VaultScanner, GraphBuilder, SA Engine, ...   |        |
|  +----------------------------------------------+        |
|         |                          |                      |
|         v                          v                      |
|  +----------------------------------------------+        |
|  |          .maencof/ (영속 인덱스)               |        |
|  +----------------------------------------------+        |
+----------------------------------------------------------+
```

### 계층 매핑

이 조합은 filid의 기존 4계층 모델과 대응한다:

| 계층 | 역할 | maencof 매핑 |
|------|------|-------------|
| Layer 1 (자동) | Hook | 컨텍스트 주입, 인덱스 무효화 |
| Layer 2 (도구) | MCP | 검색, 탐색, 상태 조회 |
| Layer 3 (에이전트) | 전용 에이전트 | 향후 확장 (자율적 지식 탐색) |
| Layer 4 (사용자) | Skill | 인덱스 빌드, 탐색, 진단 |

### 상태 공유 전략

Hook, MCP, Skill이 동일한 인덱스에 접근해야 하므로 상태 공유 규약이 필요하다.

**인덱스 위치**: `.maencof/` (저장소 루트 또는 지정 경로)

**동시 접근 제어**:
- 읽기(MCP, Hook): 항상 허용. 메모리에 로드된 스냅샷 사용.
- 쓰기(Skill/CLI): `.maencof/.lock` 파일로 배타적 접근. 빌드 중 다른 빌드 차단.
- 무효화(Hook): `.maencof/stale-nodes.json`에 무효화된 노드 목록 추가 (append-only, 락 불필요).

## MCP 도구 후보 목록

| 도구 | 설명 | Phase |
|------|------|-------|
| `kg_search` | 시드 노드 + 확산 활성화 기반 관련 문서 검색 | 1 |
| `kg_navigate` | 특정 노드의 이웃(인/아웃 링크, 부모/자식/형제) 조회 | 1 |
| `kg_context` | 쿼리에 대한 토큰 최적화 컨텍스트 블록 반환 | 1 |
| `kg_status` | 인덱스 상태, 노드/엣지 수, 마지막 빌드 시간 | 1 |
| `kg_community` | 커뮤니티별 요약 조회 | 2+ |

## Skill 후보 목록

| 스킬 | 설명 | Phase |
|------|------|-------|
| `/maencof:build` | 전체/증분 인덱스 구축 | 1 |
| `/maencof:explore` | 대화형 지식 탐색 세션 | 1 |
| `/maencof:diagnose` | 인덱스 건강도 진단 (고아 문서, 깨진 링크) | 1 |
| `/maencof:rebuild` | 인덱스 강제 전체 재구축 | 1 |

## Hook 후보 목록

| 훅 | 이벤트 | 설명 | Phase |
|----|--------|------|-------|
| `context-injector` | UserPromptSubmit | 현재 컨텍스트 기반 관련 문서 경로 자동 주입 | 1 |
| `index-invalidator` | PostToolUse (Write/Edit) | MD 파일 수정 시 해당 노드 stale 표시 | 1 |
| `session-preloader` | SessionStart | 인덱스를 메모리에 사전 로드 | 1 |
